---
title: "Sample Size (Power)"
author: "Adriana Souza"
date: "June 29, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)
library(lme4)
library(lmerTest)
library(MASS)
library(stringi)
library(lattice)
library(gridExtra)
```

# Split Plot ANOVA

A split plot design is a mixed design in which there are some repeated measures factor(s) and some between-subjects factor(s). 

\vspace{2mm}

```{r echo=FALSE}
# Reading data
data <- read.csv("oats.csv")
data <- within(data,c(nitroF <- factor(nitro),whole.plot<-replicate:variety))
glimpse(data)

#Plotting
par(cex=.5)
plot1 <- xyplot(yield~nitroF|variety,groups=replicate,aspect="xy",data)
plot2 <- xyplot(yield~nitroF|variety,groups=replicate,aspect="xy",type="o",data)
#xyplot(yield~nitroF|variety,groups=replicate,aspect="xy",type="a",data)

#Arranging graphs side by side
grid.arrange(plot1, plot2, ncol=2)
```

\newpage

We have three levels of a repeated measures factor (`r unique(data$variety)`) and four levels of a between-subjects factor, treatment (control, kill, removal + mulch, mulch), and 6 plots.

We also need to specify the error term for variety correctly. 

\vspace{2mm}

```{r previous_analysis, echo=FALSE, warning=FALSE,message=FALSE}
## Reading data

all_plots <- read.csv("plots.csv")
trees <- read.csv("trees.csv")

## Subsetting

# Subsetting trees to only Australian Pine
ap <- trees %>% filter(Species == "AP")

# Getting rid of weird formatting error, disregard
names(ap)[1] <- "PlotID" 
names(all_plots)[1] <- "PlotID"

# Subsetting Plots to exclude controls
plots <- subset(all_plots, (PlotID!=c("7", "8","9")))

# Aggregating invasive biomass per plot (note, there is no info for plots 7,8,9)
# ap_agg <- aggregate(ap[, 11], list(ap$PlotID), mean) #The functions that race used were not precise and difficult to connect to volume
# new approach: calculate biomass of trunk, branch and leaves
# scaling equations following https://doi.org/10.1371/journal.pone.0151858

ap_DBH<-as.numeric(as.character(ap$Width.cm))

#mature forest: most similar based on age table 4 eq. 7
#ap_trunk_kg<-exp(-0.963+2.032*log(ap_DBH))
#ap_branch_kg<-exp(-3.945+2.349*log(ap_DBH))
#ap_leaf_kg<-exp(-4.108+2.270*log(ap_DBH))

#middle forest: most similar based on DBH distribution NOTE: understimate because of missing correction factor
ap_trunk_kg<-exp(-2.108+2.354*log(ap_DBH))
ap_branch_kg<-exp(-4.222+2.538*log(ap_DBH))
ap_leaf_kg<-exp(-3.164+1.996*log(ap_DBH))

# convert wood (trunk and branch) to volume based on standard wood density. http://www.wood-database.com/sheoak/
ap_wood_vol_cu_m<-c(ap_trunk_kg+ap_branch_kg) / 800 # 800 kg / cubic meter https://www.researchgate.net/publication/230701880_Effects_of_height_on_physical_properties_of_wood_of_Jhau_Casuarina_equisetifolia

# convert leaf  to volume based on scaling of Specific Leaf Area Table 1 N2 average drought and control https://onlinelibrary.wiley.com/doi/pdf/10.1046/j.1365-3040.1998.00302.x
# SLA = 20 sq cm / g ; 
# area of a cylinder / volume of a cylinder = r/2 leaf diameter = 0.75 

ap_leaf_vol_cu_m<-ap_leaf_kg * 1000 * 20 * (.75 / 4) / 1000000 # 1000 g / kg * 20 sq_cm / g, (0.75 cm / 4 ) cu_cm / sq_cm  / 10^6 cu_cm / cu_m

ap_vol_cu_m<-ap_leaf_vol_cu_m+ap_wood_vol_cu_m

ap_agg <- aggregate(ap_vol_cu_m, list(ap$PlotID), sum) 

names(ap_agg)[1] <- "PlotID"
names(ap_agg)[2] <- "PlotVolume"
#head(ap_agg) # Table

## Defining variables 

# Plot Area
#sm_length_m <- plots$SpoilMoundWidth # Spoil Mound Lenght
trans_len_m <- plots$SpoilMoundTransectLength # Transect Length
sm_area_sq_m <- trans_len_m * 4 # Spoil Mound Area

# Invasive Biomass original guess
# ap_density <- 475 # ?? http://www.wood-database.com/austrian-pine/

# Target: cubic meters of invasive per meter squared of spoil mound
ap_vol_cu_m_per_sq_m_spoil_mound <- ap_agg[,2]/sm_area_sq_m

#area of all spoil ridge as per Scheda map * sq_m / acre
spoil_ridge_area_sq_m<-(3.74+7.56+.17)*4046.86

total_invasive_volume_cu_yd<-spoil_ridge_area_sq_m*ap_vol_cu_m_per_sq_m_spoil_mound*1.30795

# New table
target_table <- data.frame(ap_agg, sm_area_sq_m, ap_vol_cu_m_per_sq_m_spoil_mound,
                             total_invasive_volume_cu_yd)

# Estimate for sigma^2?
sigma_sq <- var(ap_vol_cu_m_per_sq_m_spoil_mound)
```


```{r}
#n_control <- length(unique(data$plot))
#n_subplots <- length(unique(data$variety))
#n_total <- n_control * n_subplots

#control_biomass_mean <- 
total_biomass <- total_invasive_volume_cu_yd

#effect_size <- (total_biomass - control_biomass_mean)/control_biomass_mean

# r <- 24
# n <- 8
# alpha <- 0.05
# beta <- 0.8

#sample_size <- ((r-n)/n)*((sigma_sq*alpha*beta)/effect_size)
```